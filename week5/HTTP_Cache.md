# HTTP Cache
작성자 : 김다인

---
### HTTP 캐시
컴퓨터 과학에서 캐시(cache)란, **데이터나 값을 미리 복사해 두는 임시 장소**를 가리킨다. 캐시 접근 시간에 비해 원래 데이터를 접근하는 시간이 오래 걸리거나, 값을 다시 계산하는 시간을 절약하고 싶은 경우 사용한다.  
웹사이트와 웹앱은 **이전에 가져온 리소스들을 재사용**하는 식으로 성능 향상을 꾀할 수 있다. 웹 캐시는 latency(지연/대기 시간), 트래픽을 줄임으로써 리소스를 보여주는 데 필요한 시간을 줄여준다.  
만약 웹 캐시가 저장소 내에 요청된 리소스를 갖고 있다면, 요청을 가로채 원래 서버로부터 리소스를 다시 다운로드하는 대신 리소스 복사본을 반환한다.
* 장점
	* 서버 부하 완화
	* 캐시는 원래 서버에 비해 클라이언트에 더 가까이 있으므로, 시간이 적게 걸림
* 주의할 점
	* 캐시 최신 상태 유지에 실패하면, 서버에서 리소스가 업데이트되어도 사용자들은 옛날 데이터를 보게 될 수 있음

### 캐시의 종류
![image](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching/http_cache_type.png)   

* 사설(private)
	* 1명의 사용자만 사용하는 브라우저 캐시
	* 브라우저 설정의 "caching"
	* 해당 사용자에 의해 HTTP를 통해 다운로드된 모든 문서를 갖고 있음
* 공유(shared)
	* 1명 이상의 사용자가 재사용할 수 있도록 응답을 저장하는 프록시 캐시
	* 예를 들자면, ISP(Internet Service Provider)가 많은 사용자 서비스를 위해 지역 네트워크 기반의 일부분으로 웹 프록시(캐시 서버)를 설치했을 수 있음
	* 그렇다면 조회가 많이 되는 리소스들은 재사용되어 네트워크 트래픽, latency를 줄임

### 캐싱의 대상
일반적으로 HTTP 캐시들은 GET에 대한 응답만 캐싱한다. 일반적인 캐싱 엔트리 형태는 다음과 같다.  
* 검색 요청의 결과 (GET 요청의 200 응답과 오는 HTML 문서, 이미지, 파일 등)
* 영구적 리다이렉트 (301)
* 오류 (404 결과 페이지)
* 완전하지 않은 결과 (206)

### 캐싱 제어
Cache-Control 헤더는 HTTP/1.1 기본 헤더 필드로, 요청/응답 양쪽에 있어 캐싱 메커니즘을 위해 사용된다.  
응답 헤더에 Cache-Control을 전달하면, Last-Modified가 함께 전달된다. 그럼 브라우저에서 캐시할 때 그 정보도 함께 캐시하게 된다.  
max-age가 지나면, 서버에 요청할 때 자기 캐시에 있는 Last-Modified와 서버의 Last-Modified를 비교한다. 만약 수정되지 않았다면, 응답으로 304 Not Modified와 헤더만 보낸다.  

* (1) 캐시 저장하지 않기
	* Cache-Control: no-store
* (2) 캐시하지만 유효한지 확인하기 위해 원 서버로 요청을 보내기
	* Cache-Control: no-cache
	* Cache-Control: max-age=0
	* 이 때, no-cache는 캐시를 안 한다는 의미가 아니라 캐시가 유효한지 항상 확인해야 한다는 의미이다. 즉, Last-Modified가 다를 때만 서버에서 받아오는 것이다.  
* (3) 사설 캐시와 공개 캐시
	* public은 응답이 어떤 캐시에 의해서든 캐시돼도 좋음을 의미
	* Cache-Control: public
	* private은 단일 사용자만을 위한 것이며, 공유 캐시에 의해 저장되어서는 안 됨
	* Cache-Control: private
* (4) 만료 확인
	* Expires보다 우선이 되며, 변경되지 않을 파일에 대해 긴 시간 캐싱 가능
	* Cache-Control: max-age=31536000
* (5) 검증
	* 오래된 리소스를 사용하기 전에 상태를 확인함
	* Cache-Control: must-revalidate

### 캐시 검증
캐시된 문서의 만료 시간이 다가오면 문서를 검증하거나 다시 불러오게 된다.  
* Last-Modified
	* 약한 검증으로 사용
	* Last-Modified 헤더가 응답에 존재하면, 클라이언트는 캐시된 문서 검증을 위해 If-Modified-Since 요청 헤더를 줄 수 있음
	* 검증 요청을 받은 서버는 요청을 무시하고 200 OK로 응답하거나, 브라우저에게 캐시된 복사본을 사용하도록 본문을 비운 채 304 Not Modified를 반환할 수 있음 
* ETag
	* 강한 검증으로 사용
	* Last-Modified가 부정확할 수 있기 때문에 응답 헤더에 ETag가 함께 붙음
	* 브라우저가 ETag도 캐싱해서 서버에 요청할 때 요청 헤더에 If-None-Match를 캐시해둔 ETag 값으로 보내게 됨
	* 이 때 서버가 가진 ETag 값과 같다면 서버는 304 Not Modified를 보내게 됨


---
* [MDN web docs](https://developer.mozilla.org/ko/docs/Web/HTTP/Caching)