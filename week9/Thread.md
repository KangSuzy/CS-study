
# Thread
작성자: 김다인

---

## 스레드
스레드(Thread)는 어떤 **프로세스 내에서 실행되는 흐름의 단위**, 프로세스가 할당받은 CPU, 메모리 등의 자원을 이용하는 실행 단위를 말한다.  
어떤 프로그램은 하나의 메인 스레드만 갖고 있지만(싱글 스레드), 환경에 따라 둘 이상의 스레드를 동시에 실행할 수 있다(멀티 스레드).  
단, 스레드는 디버깅이 어렵기 때문에 동기화는 주의해서 구현해야 한다.  
프로세스가 고유 공간과 자원을 할당받아 사용하는 것과 달리 하나의 스레드는 **프로세스에서 스택만 따로 할당받고, 코드, 데이터, 힙 영역은 다른 스레드들과 함께 공유**한다.
<br>
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Multithreaded_process.svg/330px-Multithreaded_process.svg.png">
<br>

### 스레드 데이터
스레드도 하나의 실행 흐름이므로 실행과 관련된 데이터를 갖는다.  
* 스레드 ID
* 프로그램 카운터
* 레지스터 집합
* 스택

상술했듯 코드, 데이터, 파일 등 기타 자원은 프로세스 내 다른 스레드와 공유한다.  

#### 스택
스택은 함수 호출 시 전달되는 인자, 돌아갈 주소값, 함수에서 선언되는 변수 등을 사용하기 위해 쓰인다. 스택 메모리 공간이 독립적이라는 것은 곧 독립적 함수 호출과 독립적 실행 흐름이 가능하다는 의미이다. 스레드에 **독립적 실행 흐름 추가**를 위한 최소 조건으로 스택을 따로 할당된다.  

#### PC 레지스터
PC(Program Counter) 값은 스레드가 명령어를 어디까지 수행했는지 나타내는데, 명령어가 연속적으로 수행되지 못하는 경우 어디까지 했는지 기억해야 하기 때문에 PC도 함께 따로 할당된다.  

### 멀티스레딩 
어떤 작업이 추가로 필요할 때마다 프로세스를 추가하는 것은 비효율적이다. 이 문제 해결을 위해 *하나의 응용 프로그램에서 여러 스레드를 구성해 각 스레드가 하나의 작업을 처리*하는 방식이 멀티 스레딩이다.  

### 프로세스와 스레드
일단 프로세스 내에 스레드가 포함된다는 것을 다시 한 번 숙지한다.  
멀티프로세스와 멀티스레드 모두 **여러 흐름이 동시에 진행**된다.  

#### 멀티스레드의 장점
멀티프로세스에서 각 프로세스는 독립적으로 실행되고, 각자 별개 메모리를 점유하지만 멀티스레드는 **프로세스 내 메모리를 공유해 사용**할 수 있으며, **스레드 간 전환 속도가 빠르기** 때문에 작업 속도도 더 빠를 수 있다.  
멀티 프로세스에 비하면, 프로세스를 써서 동시에 처리하던 것을 스레드로 구현하면 시간과 메모리 공간 등의 **시스템 자원을 덜 쓸 수 있다**는 장점이 있다. 또한 스레드 간 통신에도 힙 영역을 통해 **데이터 통신이 쉽게 가능**하며, 스레드 context switch는 프로세스처럼 캐시 메모리를 비울 필요도 없다는 장점도 있다.  

#### 멀티스레드의 단점 
멀티스레드의 단점으로 **스레드들 중 어떤 것이 먼저 실행될지 순서를 알 수 없다**는 것이 있다. 이러한 문제를 *race condition*이라고 부르며, 문제를 막기 위한 방법으로 세마포어 등이 존재한다.    
또한 멀티 프로세스에 비해 **안정성이 덜하다**. 하나의 스레드가 데이터 공간을 망가뜨리면 다른 모든 스레드들이 작동 불능 상태가 되기 때문이다. 또한 **교착 상태** 등의 문제가 생길 수 있다. 멀티 프로세스 기반에서는 프로세스 간 공유하는 자원이 없기 때문에 동일한 자원에 동시에 접근하는 일이 없지만, 멀티 스레딩 프로그래밍을 할 때는 신경써야 하는 부분이다.  
이 문제를 해결하기 위해 **동기화를 통해 작업 처리 순서를 관리**하고, **공유 자원에 대한 접근도 통제**해야 한다. 이로 인해 병목 현상이 생겨 성능이 저하될 수 있으므로 다방면으로 주의해야 한다.   

### Race Condition
공유 자원에 대해 여러 프로세스가 동시에 접근을 시도할 때 접근 타이밍이나 순서 등이 결과에 영향을 줄 수 있는 상태를 말한다. 동시에 자원에 접근하면 자료의 일관성을 해칠 수 있다.  

#### 언제 발생하며 해결책은 무엇인가?
* 커널 작업 수행 중 인터럽트 발생
	* 커널모드에서 작업을 수행하는 동안, 인터럽트를 disable시켜 CPU 제어권을 가져가지 못하도록 함
* 프로세스가 시스템 콜로 커널 모드 진입, 작업 수행 도중 context switching이 발생
	* 프로세스가 커널 모드에서 작업하는 경우 시간이 초과돼도 CPU 제어권이 다른 프로세스에게 넘어가지 않도록 함
* 멀티 프로세스 환경에서 공유 메모리 내 커널 데이터에 접근
	* 커널 내부의 공유 데이터에 접근할 때마다 데이터에 대한 락을 걸도록 함

### 교착 상태
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/Process_deadlock.svg/330px-Process_deadlock.svg.png">
<br>

교착 상태(deadlock)란 2개 이상의 작업이 서로 상대방의 작업이 끝나기만을 기다리기 때문에 결과적으로 아무것도 완료하지 못하고 무한정 기다리는 상태를 가리킨다. 다중 프로그래밍 환경에서 흔히 발생할 수 있는 문제이다.  

#### 교착 상태 발생 필요 조건
1. **상호 배제**. 프로세스들은 필요로 하는 자원에 대해 배타적 통제권을 요구함
2. **점유 대기**. 프로세스는 할당된 자원을 가진 상태에서 다른 자원을 기다림
3. **비선점**. 프로세스가 어떤 자원의 사용을 마칠 때까지 자원을 뺏을 수 없음
4. **순환 대기.** 각 프로세스는 순환적으로 다음 프로세스가 요구하는 자원을 가짐

이 중 한 가지라도 만족하지 않으면 교착 상태는 발생하지 않는다.

#### 교착 상태의 관리
결국 4가지 조건들 중 하나만 제거하면 되는데, 대부분의 교착 상태 방지 알고리즘은 4번 조건인 순환 대기 사이클 방지에 초점을 맞춘다.  

* (1) **예방**
	* 상호 배제 조건 제거
	* 점유 대기 조건 제거
		* 한 프로세스에 수행되기 전 모든 자원을 할당시키고 나서 점유하지 않을 때에는 다른 프로세스가 자원을 요구하도록 함
	* 비선점 조건 제거
		* 선점 가능한 프로토콜 만들기
	* 순환 대기 조건 제거
		* 자원 유형에 따라 순서 매기기

위와 같은 방법들은 자원 사용 효율성이 떨어지며 비용이 많이 든다.

* (2) **회피**
	*  자원이 어떻게 요청될지에 대한 추가정보를 제공하도록 요구. 시스템에 순환 대기가 일어나지 않도록 자원 할당 상태 검사
	* 자원 할당 그래프 알고리즘
	* 은행가 알고리즘

* (3) **무시**
	* 교착상태 확률이 비교적 낮은 경우 별다른 조치를 취하지 않음

* (4) **발견**
	* 감시/발견을 하는 detection 알고리즘으로 교착상태 발생 체크

##### 은행가 알고리즘
자원의 상태를 감시하고 프로세스는 사전에 자신의 작업에 필요한 자원의 수를 제시하는 교착상태 회피 알고리즘이다. 프로세스가 자원을 요구할 때, 시스템은 자원 할당 후 상태가 안정적인지 검사해 교착 상태를 회피한다.  

---
* [위키백과 : 스레드 (컴퓨팅)](https://ko.wikipedia.org/wiki/%EC%8A%A4%EB%A0%88%EB%93%9C_(%EC%BB%B4%ED%93%A8%ED%8C%85))
* [위키백과 : 멀티 스레딩](https://ko.wikipedia.org/wiki/%EB%A9%80%ED%8B%B0%EC%8A%A4%EB%A0%88%EB%94%A9) 
* [위키백과 : 경쟁 상태](https://ko.wikipedia.org/wiki/%EA%B2%BD%EC%9F%81_%EC%83%81%ED%83%9C) 
* [위키백과 : 교착 상태](https://ko.wikipedia.org/wiki/%EA%B5%90%EC%B0%A9_%EC%83%81%ED%83%9C)
* [tech-interview github repository](https://github.com/WeareSoft/tech-interview/blob/master/contents/os.md)
* [Interview_Question_for_Beginner](https://github.com/JaeYeopHan/Interview_Question_for_Beginner/blob/master/OS/README.md)
* [프로세스 & 스레드](https://github.com/gyoogle/tech-interview-for-developer/blob/master/Computer%20Science/Operating%20System/Process%20vs%20Thread.md)
* [[OS] Race Condition](https://github.com/gyoogle/tech-interview-for-developer/blob/master/Computer%20Science/Operating%20System/Race%20Condition.md)
* [은행가 (Banker's) 알고리즘](http://blog.skby.net/%EC%9D%80%ED%96%89%EA%B0%80-bankers-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98/)